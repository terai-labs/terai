import { Steps, Callout } from 'nextra/components'

# Using Terai with Node.js

**Terai** provides a robust and type-safe internationalization solution for **Node.js** applications. It is designed to be efficient, scalable, and easy to integrate into any Node.js environment, from simple scripts to complex server-side applications.

## Installation

<Steps>

### Install packages

Install the necessary packages to get started. You'll need `@terai/dev` for development tools (like extraction) and `@terai/node` for the runtime.

```sh npm2yarn
npm install -D @terai/dev
npm install @terai/node
```

### Initialize configuration

Run the initialization command to create a `terai.config.ts` file. This file will hold your project's internationalization settings.

```sh npm2yarn
npm exec terai init
```

### Configure options

Edit `terai.config.ts` to match your project needs. Here is a common configuration using the OpenAI translator:

```tsx filename="terai.config.ts"
import { defineConfig, createOpenAITranslator } from '@terai/dev'

const translator = createOpenAITranslator({
  apiKey: process.env.OPENAI_API_KEY,
  model: 'gpt-4',
})

export default defineConfig({
  include: ['./src/**/*.{js,jsx,ts,tsx}'],
  exclude: [],
  projectLocale: 'en',
  outDir: './locale-system',
  outLocales: ['es', 'it', 'fr'],
  translator,
})
```

<Callout type="info">
  The `outDir` is where Terai will output the compiled translation files. Make sure this directory is included in your build process if necessary.
</Callout>

### Setup runtime

Create a file (e.g., `i18n.ts`) to configure the Terai runtime. This is where you define how translations are loaded.

```tsx filename="src/i18n.ts"
import { setupTerai } from '@terai/node'

setupTerai({
  defaultLocale: 'en',
  // The loader function is responsible for fetching the translation data
  // for a given locale. In Node.js, this is typically a dynamic import
  // or a file system read.
  loader: (locale) => import(`../locale-system/${locale}/main.json`).then((m) => m.default),
})
```

</Steps>

## Usage

### Translating strings

Use the `getTs` function to obtain a translation function (`ts`). By default, it uses the globally configured locale.

```tsx filename="src/example.ts"
import { getTs } from '@terai/node'

export async function greetUser(name: string) {
  // 1. Get the translation function for the current locale
  const ts = await getTs()

  // 2. Use the tagged template literal to translate
  console.log(ts`Hello, ${name}! Welcome to Terai.`)
}
```

### Formatting values

Use `getFormat` to access locale-aware formatting utilities. It automatically uses the current global locale.

```tsx filename="src/example.ts"
import { getFormat } from '@terai/node'

export function printStats(amount: number, date: Date) {
  const format = getFormat()

  console.log(format.number(amount, { style: 'currency', currency: 'USD' }))
  console.log(format.date(date, { dateStyle: 'full' }))
}
```

### Changing Locale

You can change the global locale using `setLocale`. This will affect subsequent calls to `getTs` and `getFormat`.

```tsx
import { setLocale } from '@terai/node'

setLocale('es')
```

### Per-Request Locale (Async Context)

In server environments (like Express or Fastify), you often need to handle multiple locales concurrently. You can pass the locale explicitly to `getTs` to override the global setting for a specific operation.

```tsx
import { getTs } from '@terai/node'

app.get('/:locale/greet', async (req, res) => {
  const { locale } = req.params
  const ts = await getTs({ locale }) // Uses the requested locale
  res.send(ts`Hello World`)
})
```

## Workflow

### 1. Extraction

When you have added `ts` calls to your code, run the extract command to gather all strings into your source locale file.

```sh npm2yarn
npm exec terai extract
```

### 2. Translation

Run the translate command to generate translations for your configured `outLocales`.

```sh npm2yarn
npm exec terai translate
```
